name: Release VSIX Workflow
on:
  release:
    types: [published]
env:
  PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: true
  CARGO_INCREMENTAL: 0
jobs:
  check-versions-match:
    name: Check versions match
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v3
        with:
          submodules: 'true'
      - name: Install jq
        run: sudo apt-get install jq
      - run: make check_versions_match
  upload-vsix-release:
    name: Upload VSIX Release
    runs-on: ubuntu-latest
    needs:
      - check-versions-match
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v3
        with:
          submodules: 'true'
      - uses: actions-rs/toolchain@16499b5e05bf2e26879000db0c1d13f7e13fa3af # ratchet:actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown
          override: true
          profile: minimal
      - uses: Swatinem/rust-cache@82a92a6e8fbeee089604da2575dc567ae9ddeaab # ratchet:Swatinem/rust-cache@v2
      - uses: taiki-e/cache-cargo-install-action@4d586f211d9b0bca9e7b59e57e2a0febf36c0929 # ratchet:taiki-e/cache-cargo-install-action@v1
        with:
          tool: wasm-bindgen-cli
      - name: Build rust wasm
        run: make rust_build_wasm
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # ratchet:actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
      - uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # ratchet:pnpm/action-setup@v2
        with:
          version: 9
      - name: Install dependencies
        run: pnpm install -r --frozen-lockfile
      - name: Build extension
        run: pnpm run build_extension
      - name: Upload Release Asset
        uses: softprops/action-gh-release@72f2c25fcb47643c292f7107632f7a47c1df5cd8 # ratchet:softprops/action-gh-release@v2.3.2
        with:
          files: ./js/packages/quary-extension/quary-*.vsix
      - run: pnpx vsce publish --packagePath $(find ./js/packages/quary-extension/quary-*.vsix)
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
